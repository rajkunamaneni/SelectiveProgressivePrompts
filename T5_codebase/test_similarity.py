import torch
from torch import nn
import torch.nn.functional as F
from transformers import T5Tokenizer, T5EncoderModel
import numpy as np


def getEmbeddingFromText(texts):
        encoder_model = T5EncoderModel.from_pretrained("t5-large")
        tokenizer = T5Tokenizer.from_pretrained("t5-large")
        embeddings = []
        for text in texts:
            inputs = tokenizer(text, return_tensors="pt", padding=True, truncation=True)
            with torch.no_grad():
                outputs = encoder_model(input_ids=inputs['input_ids'], attention_mask=inputs['attention_mask'])
                embeddings_vec = outputs.last_hidden_state
                # mean pool embedding vecs for each token in the sequence
                embeddings_mean = torch.mean(embeddings_vec, dim=1)
                embeddings.append(embeddings_mean)
        # returns [k, 1024]
        return embeddings

# currentInput = current input embedding vec with shape of [embedding_size]
# prev_Inputs = a list of previous input embeddings of shape [embedding_size]
def similarityScore(currentInput, prev_Inputs):
        cos = nn.CosineSimilarity(dim=0)
        similarities = []
        # embedding for a single element in a batch with shape of [512,1024]
        # 1D embedding vec of [1024] for the whole sequence
        input_embed_1024 = currentInput.squeeze()
        input_embed_tensor = F.normalize(input_embed_1024, p=2, dim=0)
        
        for prev in prev_Inputs:
            prev = prev.squeeze()
            if torch.equal(input_embed_tensor, prev):
                print("SAME EMBEDDING VEC!!!")
                continue
            prev_tensor = F.normalize(prev, p=2, dim=0)
            sim = cos(input_embed_tensor, prev_tensor)
            similarities.append(sim.item())
            print("cos similarities: " , similarities)
        if not similarities:
            return 0
        # similarity = F.softmax(torch.tensor(similarities), dim=0)
        similarity = torch.tensor(similarities)
        print("similarity: ", similarity.detach().cpu().numpy().tolist())
        max = torch.max(similarity).item()
        return max

if __name__ == "__main__":
    model = T5EncoderModel.from_pretrained("t5-large")
    prev_Inputs = []
    text = ['The only thing I knew about this film prior to seeing it was Robby The Robot. My preconception was that it was another in a long line of cheesy sci-fi flicks that the 1950\'s was noted for. How wrong I was. Big studio, big budget and big production values make this a strong contender, at least visually, for the best sci-fi film coming out of the era. I qualify with the word visually, because "War Of The Worlds" is a lot darker and scarier than "Forbidden Planet", and probably fits the mold better as a foray into alien territory.<br /><br />What impressed me immediately was the color rendition of the cinematography, followed by the intricacy and scope of detail involved in Dr. Morbius\' (Walter Pidgeon) home and laboratory. But that was only the prelude to the icing on the cake, the labyrinthine underground that served as the Krell stronghold. It appeared that Krell technology was even more advanced than say, that of "Star Wars". Which made me consider, audiences for this movie back when it was released probably sat in the same kind of awe that theater goers experienced in 1977 with SW, or in 1986 with "Aliens". Watching it on a large screen TV in my living room offered me the same effect, and I\'m fairly resistant to hyperbole.<br /><br />It\'s not too much of a stretch to imagine "Forbidden Planet" as a direct antecedent of the \'Star Trek\' TV series; Gene Roddenberry himself stated that the movie had a great impact on his vision for the show. Followers of that short lived series will readily recognize plot elements used here that turned up in \'Star Trek\'. I had to do a double take when the men of United Planets Cruiser C57-V headed for a transporter room, while the conundrum presented to Robby that created an impossibility to respond was an element used at least two or three times in the ST series.<br /><br />Where the movie definitely took a cerebral turn had to do with the whole idea of \'monsters from the Id\'. That Morbius himself was using his subconscious mind to defend Altaire IV was certainly a unique concept for 1956, when every other sci-fi flick of the time was dealing with Martians or other grotesque space creatures. The film worked it\'s subtle magic on this viewer by helping me understand that Morbius was the protector of Altaire IV some time before Commander Adams (Leslie Nielsen) explained it.<br /><br />You know, looking at the calendar, the year 2200 isn\'t that far off. This movie may be the one that actually gets it right relative to exploring and living on other planets. I think though, that they\'ll have to come up with a sleeker looking version of Robby.', 'The only thing I knew about this film prior to seeing it was Robby The Robot. My preconception was that it was another in a long line of cheesy sci-fi flicks that the 1950\'s was noted for. How wrong I was. Big studio, big budget and big production values make this a strong contender, at least visually, for the best sci-fi film coming out of the era. I qualify with the word visually, because "War Of The Worlds" is a lot darker and scarier than "Forbidden Planet", and probably fits the mold better as a foray into alien territory.<br /><br />What impressed me immediately was the color rendition of the cinematography, followed by the intricacy and scope of detail involved in Dr. Morbius\' (Walter Pidgeon) home and laboratory. But that was only the prelude to the icing on the cake, the labyrinthine underground that served as the Krell stronghold. It appeared that Krell technology was even more advanced than say, that of "Star Wars". Which made me consider, audiences for this movie back when it was released probably sat in the same kind of awe that theater goers experienced in 1977 with SW, or in 1986 with "Aliens". Watching it on a large screen TV in my living room offered me the same effect, and I\'m fairly resistant to hyperbole.<br /><br />It\'s not too much of a stretch to imagine "Forbidden Planet" as a direct antecedent of the \'Star Trek\' TV series; Gene Roddenberry himself stated that the movie had a great impact on his vision for the show. Followers of that short lived series will readily recognize plot elements used here that turned up in \'Star Trek\'. I had to do a double take when the men of United Planets Cruiser C57-V headed for a transporter room, while the conundrum presented to Robby that created an impossibility to respond was an element used at least two or three times in the ST series.<br /><br />Where the movie definitely took a cerebral turn had to do with the whole idea of \'monsters from the Id\'. That Morbius himself was using his subconscious mind to defend Altaire IV was certainly a unique concept for 1956, when every other sci-fi flick of the time was dealing with Martians or other grotesque space creatures. The film worked it\'s subtle magic on this viewer by helping me understand that Morbius was the protector of Altaire IV some time before Commander Adams (Leslie Nielsen) explained it.<br /><br />You know, looking at the calendar, the year 2200 isn\'t that far off. This movie may be the one that actually gets it right relative to exploring and living on other planets. I think though, that they\'ll have to come up with a sleeker looking version of Robby.', 'The only thing I knew about this film prior to seeing it was Robby The Robot. My preconception was that it was another in a long line of cheesy sci-fi flicks that the 1950\'s was noted for. How wrong I was. Big studio, big budget and big production values make this a strong contender, at least visually, for the best sci-fi film coming out of the era. I qualify with the word visually, because "War Of The Worlds" is a lot darker and scarier than "Forbidden Planet", and probably fits the mold better as a foray into alien territory.<br /><br />What impressed me immediately was the color rendition of the cinematography, followed by the intricacy and scope of detail involved in Dr. Morbius\' (Walter Pidgeon) home and laboratory. But that was only the prelude to the icing on the cake, the labyrinthine underground that served as the Krell stronghold. It appeared that Krell technology was even more advanced than say, that of "Star Wars". Which made me consider, audiences for this movie back when it was released probably sat in the same kind of awe that theater goers experienced in 1977 with SW, or in 1986 with "Aliens". Watching it on a large screen TV in my living room offered me the same effect, and I\'m fairly resistant to hyperbole.<br /><br />It\'s not too much of a stretch to imagine "Forbidden Planet" as a direct antecedent of the \'Star Trek\' TV series; Gene Roddenberry himself stated that the movie had a great impact on his vision for the show. Followers of that short lived series will readily recognize plot elements used here that turned up in \'Star Trek\'. I had to do a double take when the men of United Planets Cruiser C57-V headed for a transporter room, while the conundrum presented to Robby that created an impossibility to respond was an element used at least two or three times in the ST series.<br /><br />Where the movie definitely took a cerebral turn had to do with the whole idea of \'monsters from the Id\'. That Morbius himself was using his subconscious mind to defend Altaire IV was certainly a unique concept for 1956, when every other sci-fi flick of the time was dealing with Martians or other grotesque space creatures. The film worked it\'s subtle magic on this viewer by helping me understand that Morbius was the protector of Altaire IV some time before Commander Adams (Leslie Nielsen) explained it.<br /><br />You know, looking at the calendar, the year 2200 isn\'t that far off. This movie may be the one that actually gets it right relative to exploring and living on other planets. I think though, that they\'ll have to come up with a sleeker looking version of Robby.', 'The only thing I knew about this film prior to seeing it was Robby The Robot. My preconception was that it was another in a long line of cheesy sci-fi flicks that the 1950\'s was noted for. How wrong I was. Big studio, big budget and big production values make this a strong contender, at least visually, for the best sci-fi film coming out of the era. I qualify with the word visually, because "War Of The Worlds" is a lot darker and scarier than "Forbidden Planet", and probably fits the mold better as a foray into alien territory.<br /><br />What impressed me immediately was the color rendition of the cinematography, followed by the intricacy and scope of detail involved in Dr. Morbius\' (Walter Pidgeon) home and laboratory. But that was only the prelude to the icing on the cake, the labyrinthine underground that served as the Krell stronghold. It appeared that Krell technology was even more advanced than say, that of "Star Wars". Which made me consider, audiences for this movie back when it was released probably sat in the same kind of awe that theater goers experienced in 1977 with SW, or in 1986 with "Aliens". Watching it on a large screen TV in my living room offered me the same effect, and I\'m fairly resistant to hyperbole.<br /><br />It\'s not too much of a stretch to imagine "Forbidden Planet" as a direct antecedent of the \'Star Trek\' TV series; Gene Roddenberry himself stated that the movie had a great impact on his vision for the show. Followers of that short lived series will readily recognize plot elements used here that turned up in \'Star Trek\'. I had to do a double take when the men of United Planets Cruiser C57-V headed for a transporter room, while the conundrum presented to Robby that created an impossibility to respond was an element used at least two or three times in the ST series.<br /><br />Where the movie definitely took a cerebral turn had to do with the whole idea of \'monsters from the Id\'. That Morbius himself was using his subconscious mind to defend Altaire IV was certainly a unique concept for 1956, when every other sci-fi flick of the time was dealing with Martians or other grotesque space creatures. The film worked it\'s subtle magic on this viewer by helping me understand that Morbius was the protector of Altaire IV some time before Commander Adams (Leslie Nielsen) explained it.<br /><br />You know, looking at the calendar, the year 2200 isn\'t that far off. This movie may be the one that actually gets it right relative to exploring and living on other planets. I think though, that they\'ll have to come up with a sleeker looking version of Robby.']
    text2 = ['I gave it a 2 instead of a 1 because I think "The Wild Women of Wongo" is worse. This is an exercise in patience. It\'s like having your teeth cleaned by a bad dental hygienist. There\'s no plot. There\'s no logic. There is certainly no acting (although the shark has some quality dialogue). We don\'t wonder about anything. We don\'t know how people got where they got. It\'s always amazing to me how things like this even get released. I agree with the previous writer that it isn\'t even funny bad. I know. It\'s about 90 minutes long and that will fill up about that much space on a DVD collection. It\'s like a paperweight. Or a bad painting you bought at a starving artists\' sale. It covers the crack in the wall.', 'I gave it a 2 instead of a 1 because I think "The Wild Women of Wongo" is worse. This is an exercise in patience. It\'s like having your teeth cleaned by a bad dental hygienist. There\'s no plot. There\'s no logic. There is certainly no acting (although the shark has some quality dialogue). We don\'t wonder about anything. We don\'t know how people got where they got. It\'s always amazing to me how things like this even get released. I agree with the previous writer that it isn\'t even funny bad. I know. It\'s about 90 minutes long and that will fill up about that much space on a DVD collection. It\'s like a paperweight. Or a bad painting you bought at a starving artists\' sale. It covers the crack in the wall.', 'I gave it a 2 instead of a 1 because I think "The Wild Women of Wongo" is worse. This is an exercise in patience. It\'s like having your teeth cleaned by a bad dental hygienist. There\'s no plot. There\'s no logic. There is certainly no acting (although the shark has some quality dialogue). We don\'t wonder about anything. We don\'t know how people got where they got. It\'s always amazing to me how things like this even get released. I agree with the previous writer that it isn\'t even funny bad. I know. It\'s about 90 minutes long and that will fill up about that much space on a DVD collection. It\'s like a paperweight. Or a bad painting you bought at a starving artists\' sale. It covers the crack in the wall.', 'I gave it a 2 instead of a 1 because I think "The Wild Women of Wongo" is worse. This is an exercise in patience. It\'s like having your teeth cleaned by a bad dental hygienist. There\'s no plot. There\'s no logic. There is certainly no acting (although the shark has some quality dialogue). We don\'t wonder about anything. We don\'t know how people got where they got. It\'s always amazing to me how things like this even get released. I agree with the previous writer that it isn\'t even funny bad. I know. It\'s about 90 minutes long and that will fill up about that much space on a DVD collection. It\'s like a paperweight. Or a bad painting you bought at a starving artists\' sale. It covers the crack in the wall.']
    text3 = ['I saw this obvious schlock fest on a video store shelf. And before i got my first VCR I figured I\'d christen it with this little gem and it\'s bad film-making at it\'s finest!<br /><br />The dialog is inadvertently hilarious. And it contains a cameo with Donald Trump. Anthony Quinn is in it inexplicably. And much like Christopher Walken seemed to want to star in every bad movie in his later years. This movie is Mr. Quinn\'s Country Bears.<br /><br />It features lines like, "Shut up and let me FIGHT!!!"<br /><br />And "You\'re saying a lot of sh_it!" <br /><br />And the priceless comeback: "Unfortunately it is sh_it, tough angry sh_it!"<br /><br />You\'ll be awed by a fight scene as Bo does a SOMMERSAULT across a billiard table! And does a nice kung fu kick when she comes up from the roll! Chop socky action and T and A thrills!!!<br /><br />What schlock movie fan could ask for more? Oh, and when Mr. Quinn\'s character commits suicide and and comes back to haunt Bo as a ghost she asks him why he killed himself rather then deal with his debilitating illness? He says, "Real men don\'t eat quiche."<br /><br />Uh, aaa, yeah. If Bo was a smart cookie she woulda called for an exorcist right then and there!', 'I saw this obvious schlock fest on a video store shelf. And before i got my first VCR I figured I\'d christen it with this little gem and it\'s bad film-making at it\'s finest!<br /><br />The dialog is inadvertently hilarious. And it contains a cameo with Donald Trump. Anthony Quinn is in it inexplicably. And much like Christopher Walken seemed to want to star in every bad movie in his later years. This movie is Mr. Quinn\'s Country Bears.<br /><br />It features lines like, "Shut up and let me FIGHT!!!"<br /><br />And "You\'re saying a lot of sh_it!" <br /><br />And the priceless comeback: "Unfortunately it is sh_it, tough angry sh_it!"<br /><br />You\'ll be awed by a fight scene as Bo does a SOMMERSAULT across a billiard table! And does a nice kung fu kick when she comes up from the roll! Chop socky action and T and A thrills!!!<br /><br />What schlock movie fan could ask for more? Oh, and when Mr. Quinn\'s character commits suicide and and comes back to haunt Bo as a ghost she asks him why he killed himself rather then deal with his debilitating illness? He says, "Real men don\'t eat quiche."<br /><br />Uh, aaa, yeah. If Bo was a smart cookie she woulda called for an exorcist right then and there!', 'I saw this obvious schlock fest on a video store shelf. And before i got my first VCR I figured I\'d christen it with this little gem and it\'s bad film-making at it\'s finest!<br /><br />The dialog is inadvertently hilarious. And it contains a cameo with Donald Trump. Anthony Quinn is in it inexplicably. And much like Christopher Walken seemed to want to star in every bad movie in his later years. This movie is Mr. Quinn\'s Country Bears.<br /><br />It features lines like, "Shut up and let me FIGHT!!!"<br /><br />And "You\'re saying a lot of sh_it!" <br /><br />And the priceless comeback: "Unfortunately it is sh_it, tough angry sh_it!"<br /><br />You\'ll be awed by a fight scene as Bo does a SOMMERSAULT across a billiard table! And does a nice kung fu kick when she comes up from the roll! Chop socky action and T and A thrills!!!<br /><br />What schlock movie fan could ask for more? Oh, and when Mr. Quinn\'s character commits suicide and and comes back to haunt Bo as a ghost she asks him why he killed himself rather then deal with his debilitating illness? He says, "Real men don\'t eat quiche."<br /><br />Uh, aaa, yeah. If Bo was a smart cookie she woulda called for an exorcist right then and there!', 'I saw this obvious schlock fest on a video store shelf. And before i got my first VCR I figured I\'d christen it with this little gem and it\'s bad film-making at it\'s finest!<br /><br />The dialog is inadvertently hilarious. And it contains a cameo with Donald Trump. Anthony Quinn is in it inexplicably. And much like Christopher Walken seemed to want to star in every bad movie in his later years. This movie is Mr. Quinn\'s Country Bears.<br /><br />It features lines like, "Shut up and let me FIGHT!!!"<br /><br />And "You\'re saying a lot of sh_it!" <br /><br />And the priceless comeback: "Unfortunately it is sh_it, tough angry sh_it!"<br /><br />You\'ll be awed by a fight scene as Bo does a SOMMERSAULT across a billiard table! And does a nice kung fu kick when she comes up from the roll! Chop socky action and T and A thrills!!!<br /><br />What schlock movie fan could ask for more? Oh, and when Mr. Quinn\'s character commits suicide and and comes back to haunt Bo as a ghost she asks him why he killed himself rather then deal with his debilitating illness? He says, "Real men don\'t eat quiche."<br /><br />Uh, aaa, yeah. If Bo was a smart cookie she woulda called for an exorcist right then and there!']
    global_list = text + text2 + text3
    global_embeds = getEmbeddingFromText(global_list)
    for embed in global_embeds:
        print("max similarity: ", similarityScore(embed, global_embeds))


    
    '''
    inputs = tokenizer(text, return_tensors="pt", padding=True, truncation=True)
    inputs2 = tokenizer(text2, return_tensors="pt", padding=True, truncation=True)
    inputs3 = tokenizer(text3, return_tensors="pt", padding=True, truncation=True)

    with torch.no_grad():
        outputs = model(input_ids=inputs['input_ids'], attention_mask=inputs['attention_mask'])
        outputs2 = model(input_ids=inputs2['input_ids'], attention_mask=inputs2['attention_mask'])
        outputs3 = model(input_ids=inputs3['input_ids'], attention_mask=inputs3['attention_mask'])

    embeddings = outputs.last_hidden_state
    embeddings_mean = torch.mean(embeddings, dim=1)
    embeddings2 = outputs2.last_hidden_state
    embeddings_mean2 = torch.mean(embeddings2, dim=1)
    embeddings3 = outputs3.last_hidden_state
    embeddings_mean3 = torch.mean(embeddings3, dim=1)
    prev_Inputs.append(embeddings_mean2)
    prev_Inputs.append(embeddings_mean3)
    print("EMBEDDING SHAPE: ")
    print(embeddings.detach().cpu().numpy().shape)
    print(embeddings2.detach().cpu().numpy().shape)
    print(embeddings3.detach().cpu().numpy().shape)

    # [1, 1024]
    print("EMBEDDING MEAN SHAPE: ")
    print(embeddings_mean.detach().cpu().numpy().shape)
    print(embeddings_mean2.detach().cpu().numpy().shape)
    print(embeddings_mean3.detach().cpu().numpy().shape)

    print("SIMILARITY SCORE: ")
    print(similarityScore(embeddings_mean, prev_Inputs))
    '''
